# Тема: Резервное копирование и восстановление

## Домашнее задание: "Бэкапы"

### 0. Подготовка:
- Создал 4 виртуальных машины в VirtualBox. На каждой VM установил кластер Postgres.
### 1. **На 1 ВМ** создаем таблицы test для записи, test2 для запросов на чтение.
- Создал БД:
```sql
maxim@maxim-virtual-machine:~$ pg_lsclusters
Ver Cluster Port Status Owner    Data directory              Log file
15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log
maxim@maxim-virtual-machine:~$ sudo -u postgres psql
[sudo] password for maxim: 
could not change directory to "/home/maxim": Permission denied
psql (15.6 (Ubuntu 15.6-1.pgdg22.04+1))
Type "help" for help.

postgres=# CREATE DATABASE replication_db;
CREATE DATABASE
postgres=# \c replication_db;
You are now connected to database "replication_db" as user "postgres".
```
- Создал роль для применения репликации:
```sql
postgres=# CREATE ROLE replication_role WITH PASSWORD 'password' LOGIN REPLICATION;
CREATE ROLE
```
- Создал таблицу test c заполнение последовательности чисел от 1 до 10 и выдал права на любые манипуляции:
```sql
replication_db=# create table test as (select generate_series(1,10)::integer as pid);
SELECT 10
replication_db=# grant insert,update,delete,select on test to replication_role;
GRANT
```
- Создал таблицу test2 и выдал права только на чтение:
```sql
replication_db=# create table test2 (pid integer);
CREATE TABLE
replication_db=# grant select on table test2 to replication_role;
GRANT
```
- Проверка прав:
```sql
replication_db=# \dp
 public | test  | table | postgres=arwdDxt/postgres     +|                   | 
        |       |       | replication_role=arwd/postgres |                   | 
 public | test2 | table | postgres=arwdDxt/postgres     +|                   | 
        |       |       | replication_role=r/postgres    |                   |
```
#
#
### 2. Создаем публикацию таблицы test и подписываемся на публикацию таблицы test2 с ВМ №2.
- Включаем логическую репликацию в кластере на VM1 и перезагружаем его:
```sql
replication_db=# ALTER SYSTEM SET wal_level = logical;
ALTER SYSTEM
replication_db=# \q
maxim@maxim-virtual-machine:~$ sudo pg_ctlcluster 15 main restart
maxim@maxim-virtual-machine:~$ sudo -u postgres psql
could not change directory to "/home/maxim": Permission denied
psql (15.6 (Ubuntu 15.6-1.pgdg22.04+1))
Type "help" for help.

postgres=# \c replication_db
You are now connected to database "replication_db" as user "postgres".
```
- Создаем публикацию для таблицы test в кластере на VM1:
```sql
replication_db=# CREATE PUBLICATION test_publicaton FOR TABLE test;
CREATE PUBLICATION
    replication_db=# \dRp+
Publication test_publicaton
  Owner   | All tables | Inserts | Updates | Deletes | Truncates | Via root 
----------+------------+---------+---------+---------+-----------+----------
 postgres | f          | t       | t       | t       | t         | f
Tables:
    "public.test"
```
- Создаем подписку на таблицу test2 на VM2 (уже должны быть выполнены шаги ниже для VM2:
```sql
-- Создаем подписку и получаем ошибку
replication_db=# CREATE SUBSCRIPTION test2_publicaton CONNECTION 'host=192.168.178.133 port=5432 user=replication_role password=password dbname=replication_db' PUBLICATION test2_publicaton WITH (copy_data = true);
ERROR:  could not connect to the publisher: connection to server at "192.168.178.133", port 5432 failed: Connection refused
	Is the server running on that host and accepting TCP/IP connections?
replication_db=# \q
maxim@maxim-virtual-machine:~$ sudo -i
[sudo] password for maxim: 
root@maxim-virtual-machine:~# echo "listen_addresses = '*'" >> /etc/postgresql/15/main/postgresql.conf
root@maxim-virtual-machine:~# echo "host replication_db replication_role 192.168.178.133/32 md5" >> /etc/postgresql/15/main/pg_hba.conf
root@maxim-virtual-machine:~# pg_ctlcluster 15 main restart

maxim@maxim-virtual-machine:~$ sudo -u postgres psql
could not change directory to "/home/maxim": Permission denied
psql (15.6 (Ubuntu 15.6-1.pgdg22.04+1))
Type "help" for help.
-- Повторно пробуем создать подписку
postgres=# \c replication_db
You are now connected to database "replication_db" as user "postgres".
replication_db=# CREATE SUBSCRIPTION test2_publicaton CONNECTION 'host=192.168.178.133 port=5432 user=replication_role password=password dbname=replication_db' PUBLICATION test2_publicaton WITH (copy_data = true);
NOTICE:  created replication slot "test2_publicaton" on publisher
CREATE SUBSCRIPTION
replication_db=# \dRs
List of subscriptions
       Name       |  Owner   | Enabled |    Publication     
------------------+----------+---------+--------------------
 test2_publicaton | postgres | t       | {test2_publicaton}
(1 row)
```
#
#
### 3. **На 2 ВМ** создаем таблицы test2 для записи, test для запросов на чтение.
- Создал БД:
```sql
maxim@maxim-virtual-machine:~$ sudo -u postgres psql
[sudo] password for maxim: 
could not change directory to "/home/maxim": Permission denied
psql (15.6 (Ubuntu 15.6-1.pgdg22.04+1))
Type "help" for help.

postgres=# CREATE DATABASE replication_db;
CREATE DATABASE
postgres=# \c replication_db;
You are now connected to database "replication_db" as user "postgres".
```
- Создал роль для применения репликации:
```sql
postgres=# CREATE ROLE replication_role WITH PASSWORD 'password' LOGIN REPLICATION;
CREATE ROLE
```
- Создал таблицу test и выдал права на чтение:
```sql
replication_db=# create table test (pid integer);
CREATE TABLE
replication_db=# grant select on test to replication_role;
GRANT
```
- Создал таблицу test2 c заполнение последовательности чисел от 11 до 20 и выдал права на любые манипуляции:
```sql
replication_db=#  create table test2 as (select generate_series(11,20)::integer as pid);
SELECT 10
replication_db=# grant insert,update,delete,select on test2 to replication_role;
GRANT
```
- Провел права:
```sql
replication_db=# \dp
                                   Access privileges
 Schema | Name  | Type  |       Access privileges        | Column privileges | Policies 
--------+-------+-------+--------------------------------+-------------------+----------
 public | test  | table | postgres=arwdDxt/postgres     +|                   | 
        |       |       | replication_role=r/postgres    |                   | 
 public | test2 | table | postgres=arwdDxt/postgres     +|                   | 
        |       |       | replication_role=arwd/postgres |                   | 
(2 rows)
```
#
#
### 4. Создаем публикацию таблицы test2 и подписываемся на публикацию таблицы test1 с ВМ №1.
- Включаем логическую репликацию в кластере на VM2 и перезагружаем его:
```sql
replication_db=# ALTER SYSTEM SET wal_level = logical;
ALTER SYSTEM
replication_db=# \q
maxim@maxim-virtual-machine:~$ sudo pg_ctlcluster 15 main restart
maxim@maxim-virtual-machine:~$ sudo -u postgres psql
could not change directory to "/home/maxim": Permission denied
psql (15.6 (Ubuntu 15.6-1.pgdg22.04+1))
Type "help" for help.

postgres=# \c replication_db
You are now connected to database "replication_db" as user "postgres".
```
- Создаем публикацию для таблицы test в кластере на VM1:
```sql
replication_db=# CREATE PUBLICATION test2_publicaton FOR TABLE test2;
CREATE PUBLICATION
replication_db=# \dRp+
Publication test2_publicaton
  Owner   | All tables | Inserts | Updates | Deletes | Truncates | Via root 
----------+------------+---------+---------+---------+-----------+----------
 postgres | f          | t       | t       | t       | t         | f
Tables:
    "public.test2"
```
- Создаем подписку на таблицу test на VM1 (уже должны быть выполнены шаги выше для VM1):
```sql
replication_db=# CREATE SUBSCRIPTION test_publicaton CONNECTION 'host=192.168.178.129 port=5432 user=replication_role password=password dbname=replication_db' PUBLICATION test_publicaton WITH (copy_data = true);
ERROR:  could not connect to the publisher: connection to server at "192.168.178.129", port 5432 failed: FATAL:  no pg_hba.conf entry for host "192.168.178.133", user "replication_role", database "replication_db", SSL encryption
connection to server at "192.168.178.129", port 5432 failed: FATAL:  no pg_hba.conf entry for host "192.168.178.133", user "replication_role", database "replication_db", no encryption
--
maxim@maxim-virtual-machine:~$ sudo -i
[sudo] password for maxim: 
root@maxim-virtual-machine:~# echo "listen_addresses = '*'" >> /etc/postgresql/15/main/postgresql.conf
root@maxim-virtual-machine:~# echo "host replication_db replication_role 192.168.178.129/32 md5" >> /etc/postgresql/15/main/pg_hba.conf
root@maxim-virtual-machine:~# pg_ctlcluster 15 main restart
--
replication_db=# CREATE SUBSCRIPTION test_publicaton CONNECTION 'host=192.168.178.129 port=5432 user=replication_role password=password dbname=replication_db' PUBLICATION test_publicaton WITH (copy_data = true);
NOTICE:  created replication slot "test_publicaton" on publisher
CREATE SUBSCRIPTION
replication_db=# \dRs
List of subscriptions
      Name       |  Owner   | Enabled |    Publication    
-----------------+----------+---------+-------------------
 test_publicaton | postgres | t       | {test_publicaton}
(1 row)
```
#
#
### 5. 3 ВМ использовать как реплику для чтения и бэкапов (подписаться на таблицы из ВМ №1 и №2 ).
- Создал БД:
```sql
maxim@maxim-virtual-machine:~$ sudo -u postgres psql
[sudo] password for maxim: 
could not change directory to "/home/maxim": Permission denied
psql (15.6 (Ubuntu 15.6-1.pgdg22.04+1))
Type "help" for help.

postgres=# CREATE DATABASE replication_db;
CREATE DATABASE
postgres=# \c replication_db;
You are now connected to database "replication_db" as user "postgres".
```
- Создал роль для применения репликации:
```sql
postgres=# CREATE ROLE replication_role WITH PASSWORD 'password' LOGIN REPLICATION;
CREATE ROLE
```
- Создал таблицу test и выдал права на чтение:
```sql
replication_db=# create table test (pid integer);
CREATE TABLE
replication_db=# grant select on test to replication_role;
GRANT
```
- Создал таблицу test2 и выдал права на чтение:
```sql
replication_db=#  create table test2 (pid integer);
CREATE TABLE
replication_db=# grant select on test2 to replication_role;
GRANT
```
- Проверил права:
```sql
replication_db=# \dp
Access privileges
 Schema | Name  | Type  |      Access privileges      | Column privileges | Policies 
--------+-------+-------+-----------------------------+-------------------+----------
 public | test  | table | postgres=arwdDxt/postgres  +|                   | 
        |       |       | replication_role=r/postgres |                   | 
 public | test2 | table | postgres=arwdDxt/postgres  +|                   | 
        |       |       | replication_role=r/postgres |                   | 
(2 rows)
```
- Реализуем подписки на таблицы VM1 и VM2
```sql
replication_db=# ALTER SYSTEM SET wal_level = logical;
ALTER SYSTEM
replication_db=# \q

maxim@maxim-virtual-machine:~$ sudo -i
[sudo] password for maxim: 
root@maxim-virtual-machine:~# echo "listen_addresses = '*'" >> /etc/postgresql/15/main/postgresql.conf
root@maxim-virtual-machine:~# echo "host replication_db replication_role 192.168.178.129/32 md5" >> /etc/postgresql/15/main/pg_hba.conf
root@maxim-virtual-machine:~# echo "host replication_db replication_role 192.168.178.133/32 md5" >> /etc/postgresql/15/main/pg_hba.conf
root@maxim-virtual-machine:~# pg_ctlcluster 15 main restart
root@maxim-virtual-machine:~$ sudo -u postgres psql
could not change directory to "/home/maxim": Permission denied
psql (15.6 (Ubuntu 15.6-1.pgdg22.04+1))
Type "help" for help.

postgres=# \c replication_db
You are now connected to database "replication_db" as user "postgres".
-- Создание подписки для таблицы test VM1
replication_db=# CREATE SUBSCRIPTION test_publicaton_vm3 CONNECTION 'host=192.168.178.129 port=5432 user=replication_role password=password dbname=replication_db' PUBLICATION test_publicaton WITH (copy_data = true);
ERROR:  could not connect to the publisher: connection to server at "192.168.178.129", port 5432 failed: FATAL:  no pg_hba.conf entry for host "192.168.178.134", user "replication_role", database "replication_db", SSL encryption
connection to server at "192.168.178.129", port 5432 failed: FATAL:  no pg_hba.conf entry for host "192.168.178.134", user "replication_role", database "replication_db", no encryption
-- Для устранения ошибки подклчился к VM1 и выполнил:
root@maxim-virtual-machine:~# echo "host replication_db replication_role 192.168.178.134/32 md5" >> /etc/postgresql/15/main/pg_hba.conf
root@maxim-virtual-machine:~# pg_ctlcluster 15 main restart
-- Повторно создаю подписку (успешно)
replication_db=# CREATE SUBSCRIPTION test_publicaton_vm3 CONNECTION 'host=192.168.178.129 port=5432 user=replication_role password=password dbname=replication_db' PUBLICATION test_publicaton WITH (copy_data = true);
NOTICE:  created replication slot "test_publicaton_vm3" on publisher
CREATE SUBSCRIPTION

-- Предварительно подключился к VM2 и выполнил:
root@maxim-virtual-machine:~# echo "host replication_db replication_role 192.168.178.134/32 md5" >> /etc/postgresql/15/main/pg_hba.conf
root@maxim-virtual-machine:~# pg_ctlcluster 15 main restart
-- Создание подписки для таблицы test2 VM2
replication_db=# CREATE SUBSCRIPTION test2_publicaton_vm3 CONNECTION 'host=192.168.178.133 port=5432 user=replication_role password=password dbname=replication_db' PUBLICATION test2_publicaton WITH (copy_data = true);
NOTICE:  created replication slot "test2_publicaton_vm3" on publisher
CREATE SUBSCRIPTION
```
#
#
### 6. (*) реализовать горячее реплицирование для высокой доступности на 4ВМ. Источником должна выступать ВМ №3. Написать с какими проблемами столкнулись.
- Настройки на VM3
```sql
-- Создадим новую роль для горячей репликации на VM3
replication_db=# CREATE ROLE hot_replication_role WITH PASSWORD 'password' LOGIN REPLICATION;
CREATE ROLE

-- Разрешим доступ на VM4 для репликации
maxim@maxim-virtual-machine:~$ sudo -i
[sudo] password for maxim: 
root@maxim-virtual-machine:~# echo "host replication hot_replication_role 192.168.178.135/32 md5" >> /etc/postgresql/15/main/pg_hba.conf

-- Проверяем текущие параметры репликации
replication_db=# show wal_level;
wal_level 
-----------
 logical
(1 row)

replication_db=# show max_wal_senders;
max_wal_senders 
-----------------
 10
(1 row)

replication_db=# show max_wal_senders;
max_wal_senders 
-----------------
 10
(1 row)

replication_db=# show wal_sender_timeout;
wal_sender_timeout 
--------------------
 1min
(1 row)

-- Меняем логическую на физческую
replication_db=# ALTER SYSTEM SET wal_level = replica;
ALTER SYSTEM
postgres=# show wal_level;
wal_level 
-----------
 replica
(1 row)

-- Перезагружаем кластер
maxim@maxim-virtual-machine:~$ sudo pg_ctlcluster 15 main restart
```
#
#
- Выполняем настройку VM4
- Проверим "standby"
```sql
maxim@maxim-virtual-machine:~$ sudo -u postgres ls -l /var/lib/postgresql/15/main
[sudo] password for maxim: 
total 84
drwx------ 5 postgres postgres 4096 мар 26 22:55 base
drwx------ 2 postgres postgres 4096 мар 31 14:41 global
drwx------ 2 postgres postgres 4096 мар 26 22:55 pg_commit_ts
drwx------ 2 postgres postgres 4096 мар 26 22:55 pg_dynshmem
drwx------ 4 postgres postgres 4096 мар 26 23:00 pg_logical
drwx------ 4 postgres postgres 4096 мар 26 22:55 pg_multixact
drwx------ 2 postgres postgres 4096 мар 26 22:55 pg_notify
drwx------ 2 postgres postgres 4096 мар 26 22:55 pg_replslot
drwx------ 2 postgres postgres 4096 мар 26 22:55 pg_serial
drwx------ 2 postgres postgres 4096 мар 26 22:55 pg_snapshots
drwx------ 2 postgres postgres 4096 мар 26 22:55 pg_stat
drwx------ 2 postgres postgres 4096 мар 26 22:55 pg_stat_tmp
drwx------ 2 postgres postgres 4096 мар 26 22:55 pg_subtrans
drwx------ 2 postgres postgres 4096 мар 26 22:55 pg_tblspc
drwx------ 2 postgres postgres 4096 мар 26 22:55 pg_twophase
-rw------- 1 postgres postgres    3 мар 26 22:55 PG_VERSION
drwx------ 3 postgres postgres 4096 мар 26 22:55 pg_wal
drwx------ 2 postgres postgres 4096 мар 26 22:55 pg_xact
-rw------- 1 postgres postgres   88 мар 26 22:55 postgresql.auto.conf
-rw------- 1 postgres postgres  130 мар 26 22:55 postmaster.opts
-rw------- 1 postgres postgres  109 мар 26 22:55 postmaster.pid
```
- Инициируем физическую репликацию с VM3 на VM4: переведем кластер в режим "standby"
```sql
maxim@maxim-virtual-machine:~$ sudo -u postgres pg_basebackup -h 192.168.178.134 -p 5432 -U hot_replication_role -D /var/lib/postgresql/15/main/  -R
could not change directory to "/home/maxim": Permission denied
Password: 
pg_basebackup: error: directory "/var/lib/postgresql/15/main/" exists but is not empty
```
- Для решения ошибки, выполнил очистку файлов кластера и выполним операцию повторно:
```sql
maxim@maxim-virtual-machine:~$ sudo -u postgres rm -rf /var/lib/postgresql/15/main/
maxim@maxim-virtual-machine:~$ sudo -u postgres pg_basebackup -h 192.168.178.134 -p 5432 -U hot_replication_role -D /var/lib/postgresql/15/main/  -R
maxim@maxim-virtual-machine:~$ sudo -u postgres ls -l /var/lib/postgresql/15/main
total 260
-rw------- 1 postgres postgres    225 мар 31 15:03 backup_label
-rw------- 1 postgres postgres 180402 мар 31 15:03 backup_manifest
drwx------ 6 postgres postgres   4096 мар 31 15:03 base
drwx------ 2 postgres postgres   4096 мар 31 15:03 global
drwx------ 2 postgres postgres   4096 мар 31 15:03 pg_commit_ts
drwx------ 2 postgres postgres   4096 мар 31 15:03 pg_dynshmem
drwx------ 4 postgres postgres   4096 мар 31 15:03 pg_logical
drwx------ 4 postgres postgres   4096 мар 31 15:03 pg_multixact
drwx------ 2 postgres postgres   4096 мар 31 15:03 pg_notify
drwx------ 2 postgres postgres   4096 мар 31 15:03 pg_replslot
drwx------ 2 postgres postgres   4096 мар 31 15:03 pg_serial
drwx------ 2 postgres postgres   4096 мар 31 15:03 pg_snapshots
drwx------ 2 postgres postgres   4096 мар 31 15:03 pg_stat
drwx------ 2 postgres postgres   4096 мар 31 15:03 pg_stat_tmp
drwx------ 2 postgres postgres   4096 мар 31 15:03 pg_subtrans
drwx------ 2 postgres postgres   4096 мар 31 15:03 pg_tblspc
drwx------ 2 postgres postgres   4096 мар 31 15:03 pg_twophase
-rw------- 1 postgres postgres      3 мар 31 15:03 PG_VERSION
drwx------ 3 postgres postgres   4096 мар 31 15:03 pg_wal
drwx------ 2 postgres postgres   4096 мар 31 15:03 pg_xact
-rw------- 1 postgres postgres    427 мар 31 15:03 postgresql.auto.conf
-rw------- 1 postgres postgres      0 мар 31 15:03 standby.signal
```
- Выполняем настройки VM3
- Создадим слот физической репликации
```sql
postgres=# select pg_create_physical_replication_slot('vm3_slot');
 pg_create_physical_replication_slot 
-------------------------------------
 (vm3_slot,)
(1 row)
postgres=# select * FROM pg_replication_slots;
slot_name | plugin | slot_type | datoid | database | temporary | active | active_pid | xmin | catalog_xmin | restart_lsn | confirmed_flush_lsn | wal_status | safe_wal_size | two_phase 
-----------+--------+-----------+--------+----------+-----------+--------+------------+------+--------------+-------------+---------------------+------------+---------------+-----------
 vm3_slot  |        | physical  |        |          | f         | f      |            |      |              |             |                     |            |               | f
(1 row)
```
- Выполняем настройки VM4
- Добавим настройку о созданном слоте в настройки кластера
```sql
root@maxim-virtual-machine:~# echo "primary_slot_name = 'vm3_slot'" >>  /etc/postgresql/15/main/postgresql.conf
root@maxim-virtual-machine:~# sudo pg_ctlcluster 15 main restart
```
- Проверим, что созданный в кластере VM3 слот перешел в активное состояние
```sql
postgres=# select * FROM pg_replication_slots;
 slot_name | plugin | slot_type | datoid | database | temporary | active | active_pid | xmin | catalog_xmin | restart_lsn | confirmed_flush_lsn | wal_status | safe_wal_size | two_phase 
-----------+--------+-----------+--------+----------+-----------+--------+------------+------+--------------+-------------+---------------------+------------+---------------+-----------
 vm3_slot  |        | physical  |        |          | f         | t      |      23438 |      |              | 0/3000148   |                     | reserved   |               | f
(1 row)
```
- Проверим, что данные с VM3 реплицируются на VM4
```sql
maxim@maxim-virtual-machine:~$ sudo -u postgres psql
[sudo] password for maxim: 
could not change directory to "/home/maxim": Permission denied
psql (15.6 (Ubuntu 15.6-1.pgdg22.04+1))
Type "help" for help.

postgres=# \c replication_db
You are now connected to database "replication_db" as user "postgres".
replication_db=# select * from test;
 pid 
-----
   1
   2
   3
   4
   5
   6
   7
   8
   9
  10
  11
(11 rows)
```