# Тема: Секционирование

## Домашнее задание: "Секционировать большую таблицу из демо базы flights."

### 1. Работы будут проводиться с тестовой БД с Postgres Pro (https://postgrespro.ru/education/demodb) - demo-big.zip версии 15.08.2017 (https://edu.postgrespro.ru/demo-big.zip)

### 2. Подготовительные работы с существующим кластером из прошлых заданий:
#### 2.1 Смотрим текущие кластера
```sql
maxim@maxim-virtual-machine:~$ pg_lsclusters
Ver Cluster Port Status Owner    Data directory              Log file
15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log
```
#### 2.2 Создаем новый кластер
```sql
maxim@maxim-virtual-machine:~$ sudo pg_createcluster 15 main2
[sudo] password for maxim: 
Creating new PostgreSQL cluster 15/main2 ...
/usr/lib/postgresql/15/bin/initdb -D /var/lib/postgresql/15/main2 --auth-local peer --auth-host scram-sha-256 --no-instructions
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with this locale configuration:
  provider:    libc
  LC_COLLATE:  en_US.UTF-8
  LC_CTYPE:    en_US.UTF-8
  LC_MESSAGES: en_US.UTF-8
  LC_MONETARY: ru_RU.UTF-8
  LC_NUMERIC:  ru_RU.UTF-8
  LC_TIME:     ru_RU.UTF-8
The default database encoding has accordingly been set to "UTF8".
    The default text search configuration will be set to "english".

    Data page checksums are disabled.

    fixing permissions on existing directory /var/lib/postgresql/15/main2 ... ok
    creating subdirectories ... ok
    selecting dynamic shared memory implementation ... posix
    selecting default max_connections ... 100
    selecting default shared_buffers ... 128MB
    selecting default time zone ... Asia/Yekaterinburg
    creating configuration files ... ok
    running bootstrap script ... ok
    performing post-bootstrap initialization ... ok
    syncing data to disk ... ok
    Ver Cluster Port Status Owner    Data directory               Log file
15  main2   5433 down   postgres /var/lib/postgresql/15/main2 /var/log/postgresql/postgresql-15-main2.log
maxim@maxim-virtual-machine:~$ pg_lsclusters
Ver Cluster Port Status Owner    Data directory               Log file
15  main    5432 online postgres /var/lib/postgresql/15/main  /var/log/postgresql/postgresql-15-main.log
15  main2   5433 online postgres /var/lib/postgresql/15/main2 /var/log/postgresql/postgresql-15-main2.log
```
#### 2.3 Скачиваем бэкап тестовой БД и разархивируем его
```sql
maxim@maxim-virtual-machine:~$ cd tmp
maxim@maxim-virtual-machine:~/tmp wget https://edu.postgrespro.ru/demo-big.zip
--2024-05-03 14:13:15--  https://edu.postgrespro.ru/demo-big.zip
Resolving edu.postgrespro.ru (edu.postgrespro.ru)... 213.171.56.196
Connecting to edu.postgrespro.ru (edu.postgrespro.ru)|213.171.56.196|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 243203214 (232M) [application/zip]
Saving to: ‘demo-big.zip’

demo-big.zip                                        100%[===================================================================================================================>] 231,94M  28,0MB/s    in 8,1s    

2024-05-03 14:13:23 (28,6 MB/s) - ‘demo-big.zip’ saved [243203214/243203214]

maxim@maxim-virtual-machine:~/tmp$ chmod 777 demo-big.zip
maxim@maxim-virtual-machine:~/tmp$ unzip demo-big.zip
Archive:  demo-big.zip
  inflating: demo-big-20170815.sql
```
#### 2.4 Загружаем бэкап тестовой БД в кластер main2 на порте 5433
```sql
maxim@maxim-virtual-machine:/tmp$ sudo -u postgres psql -p 5433 -f demo-big-20170815.sql
SET
SET
SET
SET
SET
SET
SET
SET
psql:demo-big-20170815.sql:17: ERROR:  database "demo" does not exist
CREATE DATABASE
You are now connected to database "demo" as user "postgres".
SET
SET
SET
SET
SET
SET
SET
SET
CREATE SCHEMA
COMMENT
CREATE EXTENSION
COMMENT
SET
CREATE FUNCTION
CREATE FUNCTION
COMMENT
SET
SET
CREATE TABLE
COMMENT
COMMENT
COMMENT
COMMENT
CREATE VIEW
COMMENT
COMMENT
COMMENT
COMMENT
CREATE TABLE
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
CREATE VIEW
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
CREATE TABLE
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
CREATE TABLE
COMMENT
COMMENT
COMMENT
COMMENT
CREATE TABLE
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
CREATE SEQUENCE
ALTER SEQUENCE
CREATE VIEW
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
CREATE VIEW
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
CREATE TABLE
COMMENT
COMMENT
COMMENT
COMMENT
CREATE TABLE
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
CREATE TABLE
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
COMMENT
ALTER TABLE
COPY 9
COPY 104
COPY 7925812
COPY 2111110
COPY 214867
COPY 1339
^Cpsql:demo-big-20170815.sql:13108894: ERROR:  COPY from stdin failed: canceled by user
CONTEXT:  COPY ticket_flights, line 2854557
psql:demo-big-20170815.sql:18645981: error: invalid command \.
psql:demo-big-20170815.sql:18645988: ERROR:  syntax error at or near "9512"
LINE 1: 9512 156599 Economy 11600.00
        ^
psql:demo-big-20170815.sql:21595846: error: invalid command \.
psql:demo-big-20170815.sql:21595854: ERROR:  syntax error at or near "0005432000284"
LINE 1: 0005432000284 1A40A1 4030 855525 MIKHAIL SEMENOV {"phone": "...
        ^
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER TABLE
psql:demo-big-20170815.sql:21595942: ERROR:  insert or update on table "boarding_passes" violates foreign key constraint "boarding_passes_ticket_no_fkey"
DETAIL:  Key (ticket_no, flight_id)=(0005434264785, 35613) is not present in table "ticket_flights".
psql:demo-big-20170815.sql:21595950: ERROR:  there is no unique constraint matching given keys for referenced table "aircrafts_data"
ALTER TABLE
ALTER TABLE
psql:demo-big-20170815.sql:21595974: ERROR:  there is no unique constraint matching given keys for referenced table "aircrafts_data"
ALTER TABLE
ALTER TABLE
ALTER TABLE
ALTER DATABASE
ALTER DATABASE
```
#### 2.5 Посмотрим диапазон дат в таблице flights
```sql
maxim@maxim-virtual-machine:/tmp$ sudo -u postgres psql -p 5433
psql (15.6 (Ubuntu 15.6-1.pgdg22.04+1))
Type "help" for help.

postgres=# \c demo
You are now connected to database "demo" as user "postgres".

demo=# select * from flights limit 10;
 flight_id | flight_no |  scheduled_departure   |   scheduled_arrival    | departure_airport | arrival_airport |  status   | aircraft_code | actual_departure | actual_arrival 
-----------+-----------+------------------------+------------------------+-------------------+-----------------+-----------+---------------+------------------+----------------
      2880 | PG0216    | 2017-09-14 16:10:00+05 | 2017-09-14 17:15:00+05 | DME               | KUF             | Scheduled | 763           |                  | 
      3940 | PG0212    | 2017-09-04 20:20:00+05 | 2017-09-04 21:35:00+05 | DME               | ROV             | Scheduled | 321           |                  | 
      4018 | PG0416    | 2017-09-13 21:20:00+05 | 2017-09-13 21:55:00+05 | DME               | VOZ             | Scheduled | CR2           |                  | 
      4587 | PG0055    | 2017-09-03 16:10:00+05 | 2017-09-03 17:25:00+05 | DME               | TBW             | Scheduled | CN1           |                  | 
      5694 | PG0341    | 2017-08-31 12:50:00+05 | 2017-08-31 13:55:00+05 | DME               | PES             | Scheduled | CR2           |                  | 
      6428 | PG0335    | 2017-08-24 11:30:00+05 | 2017-08-24 13:35:00+05 | DME               | JOK             | Scheduled | CN1           |                  | 
      6664 | PG0335    | 2017-09-07 11:30:00+05 | 2017-09-07 13:35:00+05 | DME               | JOK             | Scheduled | CN1           |                  | 
      7455 | PG0136    | 2017-09-10 17:30:00+05 | 2017-09-10 19:30:00+05 | DME               | NAL             | Scheduled | CR2           |                  | 
      9994 | PG0210    | 2017-09-01 20:00:00+05 | 2017-09-01 21:50:00+05 | DME               | MRV             | Scheduled | 733           |                  | 
     11283 | PG0239    | 2017-08-22 11:05:00+05 | 2017-08-22 13:40:00+05 | DME               | HMA             | Scheduled | SU9           |                  | 
(10 rows)
demo=# select min(scheduled_departure), max(scheduled_departure) from flights;
min           |          max           
------------------------+------------------------
 2016-08-15 04:45:00+05 | 2017-09-14 22:55:00+05
(1 row)
```
#### 2.6 Произведем анализ плана запроса по таблице flights до секционирования
```sql
explain analyze select * from flights where status = 'Arrived' and extract(epoch from scheduled_arrival - scheduled_departure) > 18000 and scheduled_departure between '2017-06-01'::date and '2017-06-15'::date;
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Gather  (cost=1000.00..7015.31 rows=2315 width=63) (actual time=16.573..276.957 rows=336 loops=1)
   Workers Planned: 1
   Workers Launched: 1
   ->  Parallel Seq Scan on flights  (cost=0.00..5783.81 rows=1362 width=63) (actual time=10.584..262.428 rows=168 loops=2)
         Filter: ((scheduled_departure >= '2017-06-01'::date) AND (scheduled_departure <= '2017-06-15'::date) AND ((status)::text = 'Arrived'::text) AND (EXTRACT(epoch FROM (scheduled_arrival - scheduled_departure)) > '18000'::numeric))
         Rows Removed by Filter: 107266
 Planning Time: 11.605 ms
 Execution Time: 278.196 ms
(10 rows)
```
#### 2.7 Произведем секционирование flights по диапазону дат отправки рейсов (scheduled_departure)
- Создадим копию flights
```sql
demo=# create table partition_flights (like flights including all) partition by range (scheduled_departure);
ERROR:  unique constraint on partitioned table must include all partitioning columns
DETAIL:  PRIMARY KEY constraint on table "partition_flights" lacks column "scheduled_departure" which is part of the partition key.
```
- Причины ошибки описаны по ссылкам ниже. Суть в том, что поле, по которому осуществляется секционирование - должно быть часть первичного ключа секции.
  - https://dba.stackexchange.com/questions/276291/error-insufficient-columns-in-primary-key-constraint-definition
  - https://www.postgresql.org/docs/11/ddl-partitioning.html
- Пробуем повторно создать таблицу без ключа "including all"
```sql
demo=# create table partition_flights (like flights) partition by range (scheduled_departure);
CREATE TABLE
```
- Создадим партиции:
```sql
demo=# create table partition_flights_2016_08 partition of partition_flights for values from ('2016-08-01') to ('2016-09-01');
create table partition_flights_2016_09 partition of partition_flights for values from ('2016-09-01') to ('2016-10-01');
create table partition_flights_2016_10 partition of partition_flights for values from ('2016-10-01') to ('2016-11-01');
create table partition_flights_2016_11 partition of partition_flights for values from ('2016-11-01') to ('2016-12-01');
create table partition_flights_2016_12 partition of partition_flights for values from ('2016-12-01') to ('2017-01-01');
create table partition_flights_2017_01 partition of partition_flights for values from ('2017-01-01') to ('2017-02-01');
create table partition_flights_2017_02 partition of partition_flights for values from ('2017-02-01') to ('2017-03-01');
create table partition_flights_2017_03 partition of partition_flights for values from ('2017-03-01') to ('2017-04-01');
create table partition_flights_2017_04 partition of partition_flights for values from ('2017-04-01') to ('2017-05-01');
create table partition_flights_2017_05 partition of partition_flights for values from ('2017-05-01') to ('2017-06-01');
create table partition_flights_2017_06 partition of partition_flights for values from ('2017-06-01') to ('2017-07-01');
create table partition_flights_2017_07 partition of partition_flights for values from ('2017-07-01') to ('2017-08-01');
create table partition_flights_2017_08 partition of partition_flights for values from ('2017-08-01') to ('2017-09-01');
create table partition_flights_2017_09 partition of partition_flights for values from ('2017-09-01') to ('2017-10-01');
CREATE TABLE
    CREATE TABLE
CREATE TABLE
    CREATE TABLE
CREATE TABLE
    CREATE TABLE
CREATE TABLE
    CREATE TABLE
CREATE TABLE
    CREATE TABLE
CREATE TABLE
    CREATE TABLE
CREATE TABLE
    CREATE TABLE
CREATE TABLE
    CREATE TABLE
```
- Посмотрим информацию о созданной партицированной таблице
```sql
demo=# \dt+ partition_flights
List of relations
  Schema  |       Name        |       Type        |  Owner   | Persistence | Access method |  Size   | Description 
----------+-------------------+-------------------+----------+-------------+---------------+---------+-------------
 bookings | partition_flights | partitioned table | postgres | permanent   |               | 0 bytes | 
(1 row)

demo=# \d+ partition_flights
Partitioned table "bookings.partition_flights"
            Column        |           Type           | Collation | Nullable | Default | Storage  | Compression | Stats target | Description 
---------------------+--------------------------+-----------+----------+---------+----------+-------------+--------------+-------------
 flight_id           | integer                  |           | not null |         | plain    |             |              | 
 flight_no           | character(6)             |           | not null |         | extended |             |              | 
 scheduled_departure | timestamp with time zone |           | not null |         | plain    |             |              | 
 scheduled_arrival   | timestamp with time zone |           | not null |         | plain    |             |              | 
 departure_airport   | character(3)             |           | not null |         | extended |             |              | 
 arrival_airport     | character(3)             |           | not null |         | extended |             |              | 
 status              | character varying(20)    |           | not null |         | extended |             |              | 
 aircraft_code       | character(3)             |           | not null |         | extended |             |              | 
 actual_departure    | timestamp with time zone |           |          |         | plain    |             |              | 
 actual_arrival      | timestamp with time zone |           |          |         | plain    |             |              | 
Partition key: RANGE (scheduled_departure)
Partitions: partition_flights_2016_08 FOR VALUES FROM ('2016-08-01 00:00:00+05') TO ('2016-09-01 00:00:00+05'),
            partition_flights_2016_09 FOR VALUES FROM ('2016-09-01 00:00:00+05') TO ('2016-10-01 00:00:00+05'),
            partition_flights_2016_10 FOR VALUES FROM ('2016-10-01 00:00:00+05') TO ('2016-11-01 00:00:00+05'),
            partition_flights_2016_11 FOR VALUES FROM ('2016-11-01 00:00:00+05') TO ('2016-12-01 00:00:00+05'),
            partition_flights_2016_12 FOR VALUES FROM ('2016-12-01 00:00:00+05') TO ('2017-01-01 00:00:00+05'),
            partition_flights_2017_01 FOR VALUES FROM ('2017-01-01 00:00:00+05') TO ('2017-02-01 00:00:00+05'),
            partition_flights_2017_02 FOR VALUES FROM ('2017-02-01 00:00:00+05') TO ('2017-03-01 00:00:00+05'),
            partition_flights_2017_03 FOR VALUES FROM ('2017-03-01 00:00:00+05') TO ('2017-04-01 00:00:00+05'),
            partition_flights_2017_04 FOR VALUES FROM ('2017-04-01 00:00:00+05') TO ('2017-05-01 00:00:00+05'),
            partition_flights_2017_05 FOR VALUES FROM ('2017-05-01 00:00:00+05') TO ('2017-06-01 00:00:00+05'),
            partition_flights_2017_06 FOR VALUES FROM ('2017-06-01 00:00:00+05') TO ('2017-07-01 00:00:00+05'),
            partition_flights_2017_07 FOR VALUES FROM ('2017-07-01 00:00:00+05') TO ('2017-08-01 00:00:00+05'),
            partition_flights_2017_08 FOR VALUES FROM ('2017-08-01 00:00:00+05') TO ('2017-09-01 00:00:00+05'),
            partition_flights_2017_09 FOR VALUES FROM ('2017-09-01 00:00:00+05') TO ('2017-10-01 00:00:00+05')
```
- Произведем копирование данных из исходной таблицы flights в партицированную partition_flights:
```sql
demo=# insert into partition_flights (select * from flights);
INSERT 0 214867
```
- Проверим размер партицированной таблицы и ее партиций
```sql
demo=# select 'select pg_size_pretty(pg_table_size('''||tablename||'''));' from pg_tables where tablename like 'partition_flights%';
                              ?column?                              
--------------------------------------------------------------------
 select pg_size_pretty(pg_table_size('partition_flights'));
 select pg_size_pretty(pg_table_size('partition_flights_2016_08'));
 select pg_size_pretty(pg_table_size('partition_flights_2016_09'));
 select pg_size_pretty(pg_table_size('partition_flights_2016_10'));
 select pg_size_pretty(pg_table_size('partition_flights_2016_11'));
 select pg_size_pretty(pg_table_size('partition_flights_2016_12'));
 select pg_size_pretty(pg_table_size('partition_flights_2017_01'));
 select pg_size_pretty(pg_table_size('partition_flights_2017_02'));
 select pg_size_pretty(pg_table_size('partition_flights_2017_03'));
 select pg_size_pretty(pg_table_size('partition_flights_2017_04'));
 select pg_size_pretty(pg_table_size('partition_flights_2017_05'));
 select pg_size_pretty(pg_table_size('partition_flights_2017_06'));
 select pg_size_pretty(pg_table_size('partition_flights_2017_07'));
 select pg_size_pretty(pg_table_size('partition_flights_2017_08'));
 select pg_size_pretty(pg_table_size('partition_flights_2017_09'));
(15 rows)

demo=# select pg_size_pretty(pg_table_size('partition_flights'));
select pg_size_pretty(pg_table_size('partition_flights_2016_08'));
select pg_size_pretty(pg_table_size('partition_flights_2016_09'));
select pg_size_pretty(pg_table_size('partition_flights_2016_10'));
select pg_size_pretty(pg_table_size('partition_flights_2016_11'));
select pg_size_pretty(pg_table_size('partition_flights_2016_12'));
select pg_size_pretty(pg_table_size('partition_flights_2017_01'));
select pg_size_pretty(pg_table_size('partition_flights_2017_02'));
select pg_size_pretty(pg_table_size('partition_flights_2017_03'));
select pg_size_pretty(pg_table_size('partition_flights_2017_04'));
select pg_size_pretty(pg_table_size('partition_flights_2017_05'));
select pg_size_pretty(pg_table_size('partition_flights_2017_06'));
select pg_size_pretty(pg_table_size('partition_flights_2017_07'));
select pg_size_pretty(pg_table_size('partition_flights_2017_08'));
select pg_size_pretty(pg_table_size('partition_flights_2017_09'));
pg_size_pretty 
----------------
 0 bytes
(1 row)

 pg_size_pretty 
----------------
 944 kB
(1 row)

 pg_size_pretty 
----------------
 1640 kB
(1 row)

 pg_size_pretty 
----------------
 1704 kB
(1 row)

 pg_size_pretty 
----------------
 1648 kB
(1 row)

 pg_size_pretty 
----------------
 1696 kB
(1 row)

 pg_size_pretty 
----------------
 1696 kB
(1 row)

 pg_size_pretty 
----------------
 1536 kB
(1 row)

 pg_size_pretty 
----------------
 1696 kB
(1 row)

 pg_size_pretty 
----------------
 1648 kB
(1 row)

 pg_size_pretty 
----------------
 1696 kB
(1 row)

 pg_size_pretty 
----------------
 1640 kB
(1 row)

 pg_size_pretty 
----------------
 1704 kB
(1 row)

 pg_size_pretty 
----------------
 1624 kB
(1 row)

 pg_size_pretty 
----------------
 728 kB
(1 row)
```
#### 2.8 Произведем анализ плана запроса по таблице-копии partition_flights после секционирования
```sql
explain analyze select * from partition_flights where status = 'Arrived' and extract(epoch from scheduled_arrival - scheduled_departure) > 18000 and scheduled_departure between '2017-06-01'::date and '2017-06-15'::date;
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Gather  (cost=1000.00..7064.46 rows=2553 width=63) (actual time=3.463..31.849 rows=336 loops=1)
   Workers Planned: 2
   Workers Launched: 2
   ->  Parallel Append  (cost=0.00..5809.16 rows=1071 width=63) (actual time=0.139..7.794 rows=112 loops=3)
         Subplans Removed: 13
         ->  Parallel Seq Scan on partition_flights_2017_06 partition_flights_1  (cost=0.00..439.75 rows=1494 width=63) (actual time=0.197..10.270 rows=168 loops=2)
               Filter: ((scheduled_departure >= '2017-06-01'::date) AND (scheduled_departure <= '2017-06-15'::date) AND ((status)::text = 'Arrived'::text) AND (EXTRACT(epoch FROM (scheduled_arrival - scheduled_departure)) > '18000'::numeric))
               Rows Removed by Filter: 7950
 Planning Time: 5.363 ms
 Execution Time: 34.115 ms
(10 rows)
```
#### 2.9 Выводы:
- После секционирования partition_flights и копирования в нее данных из flights - partition_flights пустая, а все данные разбиты по её секциям.
- Реальное выполнение тестового запроса после секционирования сократились в 8 раз.